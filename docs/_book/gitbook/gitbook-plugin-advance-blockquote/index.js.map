{"version":3,"file":"index.js","sources":["../src/index.js"],"sourcesContent":["// noinspection DuplicatedCode\nconst cheerio = require('cheerio');\nimport pkg from '../package.json';\n\nconst pluginName = pkg.name.replace(/^gitbook-plugin-/, '');\n\nfunction getSetting(settings, key, defaultVal, convertor) {\n\tif (settings) {\n\t\tconst match = settings.match(new RegExp(`${key}(?::([^\\\\r\\\\n|]*))?`));\n\t\tif (match) {\n\t\t\treturn convertor ? convertor(match[1]) : match[1];\n\t\t}\n\t}\n\treturn convertor ? convertor(defaultVal) : defaultVal;\n}\n\nmodule.exports = {\n\tbook: {\n\t\tassets: './dist',\n\t\t// js: [\n\t\t//   'plugin.js'\n\t\t// ],\n\t\tcss: [\n\t\t\t'index.css'\n\t\t]\n\t},\n\tebook: {\n\t\tassets: './dist',\n\t\t// js: [\n\t\t//   'plugin.js'\n\t\t// ],\n\t\tcss: [\n\t\t\t'index.css'\n\t\t]\n\t},\n\thooks: {\n\t\tpage: function (page) {\n\t\t\tconst bookIns = this;\n\t\t\tconst options = bookIns.config.get('pluginsConfig')[pluginName];\n\t\t\tconst $ = cheerio.load(page.content);\n\t\t\t$('blockquote').each((i, blockquote) => {\n\t\t\t\t// define the cheerio elements\n\t\t\t\tconst $blockquote = $(blockquote);\n\t\t\t\tconst origin = $blockquote.html();\n\t\t\t\t//origin = origin.replace(/(^<p>)|(<\\/p>$)/g,'');\n\t\t\t\tconst reg = /(?:<p>\\s*)?\\[!([!?\\w]*)((?:\\|\\w*:[^|\\]]*)*?)\\]/g;\n\t\t\t\tlet lastIndex = 0;\n\t\t\t\tlet matches;\n\t\t\t\tconst rs = [];\n\t\t\t\twhile ((matches = reg.exec(origin)) !== null) {\n\t\t\t\t\tconst index = matches.index;\n\t\t\t\t\tif (lastIndex < index) {\n\t\t\t\t\t\tif (rs.length === 0) {\n\t\t\t\t\t\t\trs.push('<blockquote>');\n\t\t\t\t\t\t}\n\t\t\t\t\t\trs.push(origin.substring(lastIndex, index));\n\t\t\t\t\t\trs.push('</blockquote>');\n\t\t\t\t\t}\n\t\t\t\t\tlastIndex = reg.lastIndex;\n\t\t\t\t\tconst match = matches[0];\n\t\t\t\t\tlet key = matches[1].trim().toLowerCase();\n\t\t\t\t\tconst settings = matches[2];\n\n\t\t\t\t\t// alias\n\t\t\t\t\tkey = ({\n\t\t\t\t\t\t'': 'tip', '?': 'question', '!': 'note', '!!': 'warning', '!!!': 'danger',\n\t\t\t\t\t\t'q': 'question', 'n': 'note',  'i': 'note', 'w': 'warning',\n\t\t\t\t\t\t'info': 'note', 'warn': 'warning', 'important': 'danger', 'error': 'danger'\n\t\t\t\t\t})[key] || key;\n\n\t\t\t\t\tconst config = options[key];\n\t\t\t\t\tif (!config) {\n\t\t\t\t\t\trs.push('<blockquote>');\n\t\t\t\t\t\trs.push(match);\n\t\t\t\t\t\tcontinue;\n\t\t\t\t\t}\n\n\t\t\t\t\t// Style configuration\n\t\t\t\t\tconst style = getSetting(settings, 'style', options.style);\n\t\t\t\t\tlet iconVisible = getSetting(settings, 'iconVisible', config.iconVisible || 'true', (v) => v !== 'false');\n\t\t\t\t\tlet labelVisible = getSetting(settings, 'labelVisible', config.labelVisible || 'true', (v) => v !== 'false');\n\t\t\t\t\tlet label = getSetting(settings, 'label', config.label);\n\t\t\t\t\tconst icon = getSetting(settings, 'icon', config.icon);\n\t\t\t\t\tconst className = getSetting(settings, 'className', config.className);\n\t\t\t\t\t// Label can be language specific and could be specified via user configuration\n\t\t\t\t\tif (typeof label === 'object') {\n\t\t\t\t\t\tconst language = bookIns.innerLanguage || bookIns.config.language;\n\t\t\t\t\t\tif (language && Object.prototype.hasOwnProperty.call(label, language)) {\n\t\t\t\t\t\t\tlabel = label[language];\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tlabel = label['en'] || label['zh'];\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tif (!label) {\n\t\t\t\t\t\tlabelVisible = false;\n\t\t\t\t\t}\n\t\t\t\t\tif (labelVisible) {\n\t\t\t\t\t\tconst iconTag = iconVisible ? `<i class=\"${icon}\"></i>` : '';\n\t\t\t\t\t\trs.push(`<blockquote class=\"alert ${style} ${className}\">\n                <p class=\"title\">${iconTag} ${label}</p>\n                <p>`);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tconst iconTag = iconVisible ? `<span class=\"title\"><i class=\"${icon}\"></i></span>` : '';\n\t\t\t\t\t\trs.push(`<blockquote class=\"alert ${style} ${className}\"><p>${iconTag} `);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tif (rs.length > 0) {\n\t\t\t\t\tif (lastIndex < origin.length) {\n\t\t\t\t\t\trs.push(origin.substring(lastIndex));\n\t\t\t\t\t}\n\t\t\t\t\trs.push('</blockquote>');\n\n\t\t\t\t\tconst content = rs.join('');\n\t\t\t\t\tif (content !== origin) {\n\t\t\t\t\t\t// append the new blockquote (as a div) to the parent\n\t\t\t\t\t\t$blockquote.before(content);\n\t\t\t\t\t\t// remove the old blockquote tag, so we dont get the default styling\n\t\t\t\t\t\t$blockquote.remove();\n\t\t\t\t\t\t// update the page content html with the new html\n\t\t\t\t\t\tpage.content = $('body').html();\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\t\t\treturn page;\n\t\t}\n\t},\n\tblocks: {},\n\tfilters: {},\n};\n"],"names":["cheerio","require","pluginName","pkg","name","replace","getSetting","settings","key","defaultVal","convertor","match","RegExp","concat","module","exports","book","assets","css","ebook","hooks","page","bookIns","this","options","config","get","$","load","content","each","i","blockquote","matches","$blockquote","origin","html","reg","lastIndex","rs","exec","index","length","push","substring","trim","toLowerCase","q","n","w","info","warn","important","error","style","iconVisible","v","labelVisible","label","icon","className","_typeof","language","innerLanguage","Object","prototype","hasOwnProperty","call","iconTag","join","before","remove","blocks","filters"],"mappings":"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"}